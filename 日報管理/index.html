<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('reset').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  <script src="https://cdn.jsdelivr.net/npm/@koozaki/romaji-conv@2.0.20/dist/romaji-conv.js"></script>
  <script>
    //該当者をあ～わ毎に分ける配列.
    let g_syllabary = [[], [], [], [], [], [], [], [], [], []];

    let g_workerData = null;


    // 清音をキーにしたオブジェクト
      const seionKeyObj = {
        'か': 'が',
        'き': 'ぎ',
        'く': 'ぐ',
        'け': 'げ',
        'こ': 'ご',
        'さ': 'ざ',
        'し': 'じ',
        'す': 'ず',
        'せ': 'ぜ',
        'そ': 'ぞ',
        'た': 'だ',
        'ち': 'ぢ',
        'つ': 'づ',
        'て': 'で',
        'と': 'ど',
        'は': 'ば',
        'ひ': 'び',
        'ふ': 'ぶ',
        'へ': 'べ',
        'ほ': 'ぼ',
        'う': 'ヴ'
      };

      // 濁音・半濁音をキーにしたオブジェクト
      const dakuonHandakuonKeyObj = {
          'が': 'か',
          'ぎ': 'き',
          'ぐ': 'く',
          'げ': 'け',
          'ご': 'こ',
          'ざ': 'さ',
          'じ': 'し',
          'ず': 'す',
          'ぜ': 'せ',
          'ぞ': 'そ',
          'だ': 'た',
          'ぢ': 'ち',
          'づ': 'つ',
          'で': 'て',
          'ど': 'と',
          'ば': 'は',
          'び': 'ひ',
          'ぶ': 'ふ',
          'べ': 'へ',
          'ぼ': 'ほ',
          'ヴ': 'う',
          'ガ': 'か',
          'ギ': 'き',
          'グ': 'く',
          'ゲ': 'け',
          'ゴ': 'こ',
          'ザ': 'さ',
          'ジ': 'し',
          'ズ': 'す',
          'ゼ': 'せ',
          'ゾ': 'そ',
          'ダ': 'た',
          'ヂ': 'ち',
          'ヅ': 'つ',
          'デ': 'て',
          'ド': 'と',
          'バ': 'は',
          'ビ': 'ひ',
          'ブ': 'ふ',
          'ベ': 'へ',
          'ボ': 'ほ',
          'ぱ': 'は',
          'ぴ': 'ひ',
          'ぷ': 'ふ',
          'ぺ': 'へ',
          'ぽ': 'ほ',
          'パ': 'は',
          'ピ': 'ひ',
          'プ': 'ふ',
          'ペ': 'へ',
          'ポ': 'ほ'
      };
      const seionHandakuon_KeyObj = {
          'は': 'ぱ',
          'ひ': 'ぴ',
          'ふ': 'ぷ',
          'へ': 'ぺ',
          'ほ': 'ぽ',
          'ハ': 'パ',
          'ヒ': 'ピ',
          'フ': 'プ',
          'ヘ': 'ペ',
          'ホ': 'ポ'
      };
  // 指定した時間だけ待つための関数
  function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // 清音から濁音に変換
  function convert2Dakuon(character) {
    let result = character;
    if (character in seionKeyObj){
      result = seionKeyObj[character];
    }
    return result;
  }

  // 濁音から清音に変換
  function convert2Seion(character) {
    let result = character;
    if (character in dakuonHandakuonKeyObj){
      result = dakuonHandakuonKeyObj[character];
    }
    return result;
  }
  // 清音から半濁音
  function convert2HanDakuon(character) {
    // 清音をキーにしたオブジェクト
    let result = character;
    if (character in seionHandakuon_KeyObj){
      result = seionHandakuon_KeyObj[character];
    }
    return result;
  }

  // ページが読み込まれた際に最初に実行される関数
  document.addEventListener('DOMContentLoaded', initialize);

  async function initialize() {
    // ページが更新された時点で社員情報を取得
    google.script.run.withSuccessHandler(getWorkerData).getSheetValues("社員情報");

    function getWorkerData(result) {
      g_workerData = result;
    }
    // 戻り値が入ったらループを抜ける
    let count = 0;
    while (g_workerData == null){
      count += 1;
      await wait(100);
      if (count == 60){
        initialize();
        console.log("再読み込み")
        return;
      }
    }
    // GAS上でエラーが発生していないか確認
    if (g_workerData.indexOf("ERROR:") != -1){
      console.log(g_workerData);
      return;
    }

    function sortWorkerData(data) {
      // 社員IDが数値でない場合、社員IDを数値に変換して比較する関数
      const compare_ById = (a, b) => {
        if (typeof a[2] === 'number' && typeof b[2] === 'number') {
          return a[2] - b[2];
        } else if (typeof a[2] === 'string' && typeof b[2] === 'string') {
          // 文字列の場合は辞書順に比較（大文字小文字を区別せず）
          const id_a = a[2].toLowerCase();
          const id_b = b[2].toLowerCase();
          return id_a.localeCompare(id_b);
        } else {
          // 数値と文字列の場合は数値が先に来るように比較
          return typeof a[2] === 'number' ? -1 : 1;
        }
      };

      // 配列の1行目（ヘッダー）を除外してソート
      const sortedData = data.slice(1).sort(compare_ById);

      // ヘッダーとソート済みデータを結合して新しい配列を作成して返す
      const sortedWorkerData = [data[0], ...sortedData];
      return sortedWorkerData;
    }

    const sortedWorkerData = sortWorkerData(g_workerData);

    for (let i = 1; i < sortedWorkerData.length; i++){

      // 社員社員の有効期限が「なし」ではなく、日付が設定されている場合
      let woker_limit = sortedWorkerData[i][4];
      if ( woker_limit != "なし" || woker_limit != "" ){
        woker_limit_date = new Date(woker_limit);
        // 今の時刻が有効期限を超えていた場合
        if (new Date() > woker_limit_date){
          continue;
        }
      }
      let initials = romajiConv(convert2Seion(sortedWorkerData[i][2][0])).toHiragana();

      // 各仮名の開始文字列を配列に格納
      let syllabaries = ["あいうえお", "かきくけこ", "さしすせそ", "たちつてと", "なにぬねの", "はひふへほ", "まみむめも", "やゆよ", "らりるれろ", "わをん"];

      // マッチする仮名を探す
      for (let j = 0; j < syllabaries.length; j++) {
        if (syllabaries[j].indexOf(initials) !== -1) {
          g_syllabary[j].push(sortedWorkerData[i]);
          break; // マッチしたらループから抜ける
        }
      }

    }
    // ローディング画面を外す
    // ローディング画面を非表示にする
    document.getElementById("loading_text").textContent = "読み込み完了";
    await wait(900);
    document.getElementById("page_loading").style.display = "none";
    initials_select(0);
  }

  // 全角文字を半角にする関数
  var toHalfWidth = function(value) {
    if (!value) return value;
    return String(value).replace(/[！-～]/g, function(all) {
      return String.fromCharCode(all.charCodeAt(0) - 0xFEE0);
    });
  };


  // あ～わのボタンを選択された時に呼び出される関数
  let gSelect_initials_val = 0;
  function initials_select(val) {
    gSelect_initials_val = val;
    // name_suggestの子要素を削除
    name_suggest = document.getElementById("name_suggest");
    name_suggest.innerHTML = '';
    document.getElementById("name_input").value = "";

    if (g_syllabary[val].length == 0){
      let p = document.createElement("p");
      p.innerText = "該当なし";
      name_suggest.appendChild(p);
    }
    for (let i = 0; i < g_syllabary[val].length; i++){
      let p = document.createElement("p");
      p.setAttribute('onclick', 'name_suggest_click(this.textContent)');
      p.innerText = g_syllabary[val][i][1].replace("　", " ") + " (" + g_syllabary[val][i][0] + ")";
      name_suggest.appendChild(p);
    }
    // 選択中のボタンのbackgroud-colorを変更
    select_initials = document.getElementById("select_initials");
    for (let i = 0; i < select_initials.children.length; i++){
      if (i == val){
        select_initials.getElementsByTagName("div")[i].style.borderColor = "#000";
        select_initials.getElementsByTagName("div")[i].style.color = "#fff";
        select_initials.getElementsByTagName("div")[i].style.backgroundColor = "#f86d17";
      }else {
        select_initials.getElementsByTagName("div")[i].style.borderColor = "#000"
        select_initials.getElementsByTagName("div")[i].style.color = "#000";
        select_initials.getElementsByTagName("div")[i].style.backgroundColor = "rgb(221, 221, 221)";
      }
      if ( i >= 1 ) {
        select_initials.getElementsByTagName("div")[i].style.borderWidth = "1px 1px 1px 0px";
      }
    }
  }
  // 氏名入力inputタグに入力があった際に呼び出される関数
  function name_input_event(text){
    let initials = text[0];
    if ("あいうえおaiueo".indexOf(initials) != -1){
      gSelect_initials_val = 0;
    }else if("かきくけこk".indexOf(initials) != -1){
      gSelect_initials_val = 1;
    }else if("さしすせそs".indexOf(initials) != -1){
      gSelect_initials_val = 2;
    }else if("たちつてとt".indexOf(initials) != -1){
      gSelect_initials_val = 3;
    }else if("なにぬねのn".indexOf(initials) != -1){
      gSelect_initials_val = 4;
    }else if("はひふへほh".indexOf(initials) != -1){
      gSelect_initials_val = 5;
    }else if("まみむめもm".indexOf(initials) != -1){
      gSelect_initials_val = 6;
    }else if("やゆよy".indexOf(initials) != -1){
      gSelect_initials_val = 7;
    }else if("らりるれろr".indexOf(initials) != -1){
      gSelect_initials_val = 8;
    }else if("わをんw".indexOf(initials) != -1){
      gSelect_initials_val = 9;
    }
    if (text.length >= 1) {
      document.getElementById("name_input").style.borderRight = "none";
      document.getElementById("name_input").style.margin = "10px 0px 0px 10px";
      document.getElementById("name_input_back_delete").style.display = "inline";
      // かじら文字に該当する選択部分の色付けを行う
      select_initials = document.getElementById("select_initials");
      for (let i = 0; i < select_initials.children.length; i++){
          select_initials.getElementsByTagName("div")[i].style.borderColor = "#000000"
          select_initials.getElementsByTagName("div")[i].style.color = "#000000";
          select_initials.getElementsByTagName("div")[i].style.backgroundColor = "rgb(221, 221, 221)";
      }
      // name_suggestの子要素を削除
      name_suggest = document.getElementById("name_suggest");
      name_suggest.innerHTML = '';
      text = text.replace("　", "").replace(" ", "");
      var romaji = romajiConv(text);
      let hira_text = romajiConv(romaji.toHiragana()).toHiragana();


      // 入力した文字と一致する名前をサジェストに反映させる
      for (let j = 0; j < g_syllabary.length; j++){
        for (let i = 0; i < g_syllabary[j].length; i++){
          //社員名(漢字)➤社員名(ひらがな)➤社員IDの順で比較.
          if (g_syllabary[j][i][1].replace(" ", "").indexOf(text) != -1||
          g_syllabary[j][i][1].replace(" ", "").indexOf(hira_text) != -1 ||
          g_syllabary[j][i][2].replace(" ", "").indexOf(text) != -1 ||
          g_syllabary[j][i][2].replace(" ", "").indexOf(hira_text) != -1 ||
          romajiConv(g_syllabary[j][i][2].replace(" ", "")).toHiragana().indexOf(hira_text) != -1 ||
          (g_syllabary[j][i][0] + "").replace(" ", "").indexOf(toHalfWidth(text).toUpperCase()) != -1){


            let p = document.createElement("p");
            p.setAttribute('onclick', 'name_suggest_click(this.textContent)');
            p.innerText = g_syllabary[j][i][1] + " (" + g_syllabary[j][i][0] + ")";
            name_suggest.appendChild(p);
          }
        }
      }


      // 一件も一致しなかった場合
      if (name_suggest.children.length == 0){
        let p = document.createElement("p");
        p.innerText = "該当なし";
        name_suggest.appendChild(p);
      }
    }else {
      document.getElementById("name_input").style.borderRight = "1px solid";
      document.getElementById("name_input").style.margin = "10px 10px 0px 10px";
      document.getElementById("name_input_back_delete").style.display = "none";
      // 一件も一致しなかった場合
      if (name_suggest.children.length == 0){
        let p = document.createElement("p");
        p.innerText = "該当なし";
        name_suggest.appendChild(p);
      }else {
        initials_select(gSelect_initials_val);
      }
    }


  }
  // 氏名入力inputタグの横についている削除ボタンを押下したときに呼び出される関数
  function name_input_delete(){
    document.getElementById("name_input").value = "";
    document.getElementById("name_input").style.borderRight = "1px solid";
    document.getElementById("name_input").style.margin = "10px 10px 0px 10px";
    document.getElementById("name_input_back_delete").style.display = "none";
    initials_select(0);
  }


  // 氏名選択サジェスト内の要素を選択したときに呼び出される関数
  function name_suggest_click(val) {
    document.getElementById("roginBg1").style.display = "none";
    document.getElementById("select_name").style.display = "none";
    document.getElementById("login_confirm").style.display = "block";
    let name = val.substring(0, val.indexOf("(")-1);
    let id = val.substring(val.indexOf("(")+1 , val.length-1);
    document.getElementById("loginConfirmName").innerHTML = name;
    document.getElementById("loginConfirmId").innerText = "ID:" + id;
    let sc_flg = document.fullscreen;
    let url = "<?=getScriptUrl()?>?p=calendar&name="+name+"&id="+id;
    document.getElementById("login").setAttribute("href", encodeURI(url))
  }
  // ログイン確認時に「戻る」を押下した際に呼び出される関数
  function login_confirm_back(){
    document.getElementById("roginBg1").style.display = "flex";
    document.getElementById("select_name").style.display = "inline";
    document.getElementById("login_confirm").style.display = "none";
  }


  </script>
</head>

<body>
  <div id="page_loading">
    <div class="wrapper">
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="shadow"></div>
      <div class="shadow"></div>
      <div class="shadow"></div>
      <span id="loading_text">読み込み中・・・</span>
    </div>
  </div>
  <div class="roginMenu">
    <header class="roginHeader">
      <p class="roginTitle">
        ログインフォーム
      </p>
    </header>
    <!-- メイン -->

    <div id="roginBg1">
      <div class="roginBg2">
        <div id="select_name">
          <p class="nameInfo">氏名を選択してください</p>
          <div style="display:flex;" id="select_initials">
            <div onclick="initials_select(0)">あ</div>
            <div onclick="initials_select(1)">か</div>
            <div onclick="initials_select(2)">さ</div>
            <div onclick="initials_select(3)">た</div>
            <div onclick="initials_select(4)">な</div>
            <div onclick="initials_select(5)">は</div>
            <div onclick="initials_select(6)">ま</div>
            <div onclick="initials_select(7)">や</div>
            <div onclick="initials_select(8)">ら</div>
            <div onclick="initials_select(9)">わ</div>
          </div>
          <div style="display:flex;">
            <input id="name_input" type="text" placeholder="氏名を入力" oninput="name_input_event(this.value)"  pattern="[\u3041-\u3096]*">
            <button id="name_input_back_delete" onclick="name_input_delete()">✕</button>
          </div>

          <div id="name_suggest">
            <p>取得中</p>
          </div>
        </div>
      </div>
    </div>
    <div id="login_confirm">
      <div class="loginConfirmBg">
        <p class="loginConfirmTitle">本人確認</p>
        <br>
        <p id="loginConfirmName"></p>
        <p id="loginConfirmId">社員ID：</p>
        <br>
        <div class="loginConfirmBtnGroup">
          <div class="login_confirm_btn1" onclick="login_confirm_back();">
            <p class="backBtnText" style="color: #fff;">戻る</p>
          </div>
          <a class="login_confirm_btn2" id="login" href="<?=getScriptUrl()?>?p=order">ログイン</a>
        </div>
      </div>
    </div>
    <div>
</body>

</html>